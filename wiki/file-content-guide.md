# 文件内容获取指南

## 概述

本指南说明如何配置钉钉-Dify适配器，使其能够获取文件的实际内容并发送给Dify进行AI分析。

## 功能特性

- **文件元数据获取**：自动提取文件名、大小、类型等信息
- **文件内容下载**：从钉钉云盘下载文件内容（支持文本文件）
- **智能编码处理**：自动处理UTF-8、GBK等不同编码格式
- **内容长度限制**：可配置下载和发送的内容大小限制
- **AI集成**：将文件内容发送给Dify进行智能分析

## 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```bash
# 文件处理配置
MAX_FILE_SIZE_MB=100                    # 最大上传文件大小（MB）
MAX_DOWNLOAD_SIZE_MB=10                 # 最大下载文件大小（MB）
UPLOAD_TO_DIFY=true                     # 是否发送文件信息给Dify
ENABLE_DINGTALK_DRIVE=true              # 是否启用钉钉云盘功能

# 钉钉云盘配置
DINGTALK_DRIVE_SPACE_TYPE=org           # 云盘空间类型
DINGTALK_DRIVE_STORAGE_DRIVER=DINGTALK  # 存储驱动
DINGTALK_DRIVE_CONFLICT_STRATEGY=OVERWRITE  # 冲突处理策略
DINGTALK_DRIVE_CONVERT_TO_ONLINE_DOC=false  # 是否转换为在线文档
```

### 关键配置项说明

- **MAX_DOWNLOAD_SIZE_MB**: 控制从钉钉云盘下载文件内容的最大大小，默认10MB
- **UPLOAD_TO_DIFY**: 必须设置为 `true` 才能启用Dify集成
- **ENABLE_DINGTALK_DRIVE**: 必须设置为 `true` 才能启用文件内容下载

## 支持的文件类型

### 文本文件（支持内容提取）
- 纯文本：`.txt`, `.md`, `.log`
- 代码文件：`.py`, `.java`, `.cpp`, `.js`, `.html`, `.css`
- 配置文件：`.json`, `.xml`, `.yaml`, `.ini`, `.conf`
- 数据文件：`.csv`, `.tsv`, `.sql`
- 脚本文件：`.sh`, `.bat`, `.ps1`

### 二进制文件（仅支持元数据）
- 图片：`.jpg`, `.png`, `.gif`, `.bmp`
- 文档：`.pdf`, `.doc`, `.docx`, `.xls`, `.xlsx`
- 音频：`.mp3`, `.wav`, `.aac`
- 视频：`.mp4`, `.avi`, `.mov`
- 压缩包：`.zip`, `.rar`, `.7z`

## 工作流程

### 1. 文件接收
用户向钉钉机器人发送文件

### 2. 信息提取
系统自动提取文件元数据（名称、大小、类型）

### 3. 云盘上传
将文件上传到钉钉云盘（如果启用）

### 4. 内容下载
对于支持的文本文件，尝试从云盘下载内容

### 5. Dify处理
将文件信息和内容（如果有）发送给Dify

### 6. 结果返回
返回AI分析结果和云盘链接

## 使用示例

### 发送文本文件
用户发送一个 `.txt` 文件：
```
文件名: 报告.txt
大小: 2.5KB
类型: text/plain
```

系统会：
1. 上传文件到钉钉云盘
2. 下载文件内容
3. 发送给Dify进行分析
4. 返回分析结果

### 发送图片文件
用户发送一个 `.jpg` 图片：
```
文件名: 截图.jpg
大小: 500KB
类型: image/jpeg
```

系统会：
1. 上传文件到钉钉云盘
2. 无法下载内容（图片不支持文本提取）
3. 发送文件元数据给Dify
4. 返回基于元数据的分析结果

## 注意事项

### 权限要求
- 钉钉应用需要开通云盘权限
- 需要足够的云盘存储空间
- 用户需要授权访问云盘

### 性能考虑
- 大文件下载会增加响应时间
- 建议设置合理的 `MAX_DOWNLOAD_SIZE_MB` 值
- 文本文件内容会被截取到合理长度

### 安全考虑
- 文件内容会发送给Dify，确保Dify环境安全
- 敏感文件建议不要通过此方式处理
- 可以设置文件类型白名单

## 故障排除

### 常见问题

1. **无法获取文件内容**
   - 检查 `ENABLE_DINGTALK_DRIVE` 是否设置为 `true`
   - 确认钉钉应用有云盘权限
   - 检查文件类型是否支持

2. **下载失败**
   - 检查网络连接
   - 确认访问令牌有效
   - 检查文件是否已上传到云盘

3. **编码错误**
   - 系统会自动尝试UTF-8和GBK编码
   - 如果都失败，会返回十六进制表示

### 日志查看
查看 `logs/` 目录下的日志文件，了解详细的执行过程和错误信息。

## 高级配置

### 自定义文件类型支持
可以在 `_is_text_file` 方法中添加更多支持的文件扩展名。

### 内容处理策略
可以修改 `_process_with_dify` 方法，实现自定义的内容处理逻辑。

### 错误处理
可以增强错误处理机制，提供更友好的用户提示。 